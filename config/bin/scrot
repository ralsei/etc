#!/bin/sh

SCROT_FILE="/home/hazel/usr/img/scrots/$(date +"scr_%Y-%m-%d_%H-%M-%S").png"

send_notification() {
    if [ -n "$1" ]; then
        wl-copy "$1"
        notify-send -i "$SCROT_FILE" "Screenshot saved!" "URL: $1" -t 2500
    else
        # only copy the image if we aren't already copying the URL
        wl-copy -t image/png < "$SCROT_FILE"
        notify-send -i "$SCROT_FILE" "Screenshot saved!" -t 2500
    fi
}

grab_selection() {
    SCROT_AREA="$(swaymsg -t get_tree | jq -r '.. | (.nodes? // empty)[] | select(.pid and .visible) | .rect | "\(.x),\(.y) \(.width)x\(.height)"' | slurp)"
    grim -g "$SCROT_AREA" "$SCROT_FILE"
}

grab_full() {
    grim "$SCROT_FILE"
}

upload_scrot() {
    API_KEY="$(jq -r '.apikey' < "$HOME"/.config/linx-client.conf)" # reinventing the wheel
    curl -s -H "Linx-Api-Key: $API_KEY" -H "Linx-Randomize: yes" -H "Accept: application/json" \
         -T "$SCROT_FILE" https://p.qtp2t.club/upload/ | jq -r '.url'
}

case "$1" in
    selup)
        grab_selection && send_notification "$(upload_scrot)"
        ;;
    sel)
        grab_selection && send_notification
        ;;
    fullup)
        grab_full && send_notification "$(upload_scrot)"
        ;;
    full)
        grab_full && send_notification
        ;;
    *)
        echo "usage: scrot [full|sel|fullup|selup]"
        return 1
        ;;
esac
