#!/usr/bin/env bash
#
# Control keyboard layout and backlight (Lenovo ThinkPad tested only)
#
# Author: Dave Eddy <dave@daveeddy.com>
# Date: June 25, 2018
# License: MIT


TMPFILE=/tmp/keyboard-status

# taken from https://wiki.archlinux.org/index.php/Keyboard_backlight
setKeyboardLight() {
	echo "$1" > "$TMPFILE"

	dbus-send --system --type=method_call \
	    --dest='org.freedesktop.UPower' \
	    '/org/freedesktop/UPower/KbdBacklight' \
	    'org.freedesktop.UPower.KbdBacklight.SetBrightness' \
	    "int32:$1"
}

# cycle the current state of the keyboard backlight
cycleKeyboardLight() {
	local cur
	cur="$(cat $TMPFILE)"
	
	case "$cur" in
		0) setKeyboardLight 1;;
		1) setKeyboardLight 2;;
		2) setKeyboardLight 0;;
		*) exit 1;;
	esac
}

usage() {
	local prog=${0##*/}
	cat <<-EOF
	Usage: $prog <command>

	Examples
	  # control backlight
	  $prog [off | dim | bright/on]

	  # print help
	  $prog help
	EOF
}

if [[ ! -f "$TMPFILE" ]]; then
	echo '0' > "$TMPFILE"
fi

case "$1" in
	# lights
	off) setKeyboardLight 0;;
	dim) setKeyboardLight 1;;
	on|bright) setKeyboardLight 2;;
	cycle) cycleKeyboardLight;;

	help|-h) usage; exit 0;;

	*) usage >&2; exit 1;;
esac
